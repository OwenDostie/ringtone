<!doctype html>
<h2>RINGTONE</h2>
<label for="fname">enter your name:</label>
<input type="text" id="fname" name="fname"><br><br>
<label for="lobbyId">enter the lobby id:</label>
<input type="text" id="lobbyId" name="lobbyId">
<button onclick="onClickJoinLobby()" type="button">join lobby!</button> <br><br>
<button onclick="onClickHost()" type="button">host a lobby!</button> 
<div id="output"></div>
<div id="lobbyMemberList">
  <h3>lobby member list</h3><br>
    <ul id="membersList"></ul>
  <h2>connected to lobby with code: </h3>
    <h2 id="lobbyCode"></h2>
    <br>
</div>

<script>
  const wsUri = "ws://127.0.0.1/";
  const output = document.querySelector("#output");
  const membersList = document.querySelector("#membersList");
  const lobbyCode = document.querySelector("#lobbyCode");
  const websocket = new WebSocket(wsUri);
  let pingInterval;

  function writeToScreen(message) {
    output.insertAdjacentHTML("afterbegin", `<p>${message}</p>`);
  }

  function sendMessage(message) {
    writeToScreen(`SENT: ${message}`);
    websocket.send(message);
  }

  function onClickJoinLobby() {
    const msg = {
        type: "join_request",
        user_name: document.getElementById("fname").value,
        lobby_code: document.getElementById("lobbyId").value,
        date: Date.now(),
    }
    writeToScreen(`tryna JOIN UP lobby ${msg.lobby_code}`);
    websocket.send(JSON.stringify(msg));
  }

  function onClickHost() {
    const msg = {
        type: "host_request",
        hoster_name: document.getElementById("fname").value,
        date: Date.now(),
    }
    writeToScreen(`sent my name to teh server :3}`);
    websocket.send(JSON.stringify(msg));
  }

  websocket.onopen = (e) => {
    writeToScreen("CONNECTED");
  };

  websocket.onclose = (e) => {
    writeToScreen("DISCONNECTED");
    clearInterval(pingInterval);
  };

  websocket.onmessage = (e) => {
    writeToScreen(`RECEIVED: ${e.data}`);

    const message_obj = JSON.parse(e.data);

    // big switch case for handling mesasges from the server
    switch(message_obj.type) {
      case 'lobby_update':
        console.log('got a message for lobby update')
        updateLobbyMemberList(message_obj.members);
        updateLobbyCode(message_obj.code);
    }
  };

  websocket.onerror = (e) => {
    writeToScreen(`ERROR: ${e.data}`);
  };

  function updateLobbyMemberList(members) {
    membersList.innerHTML = '';

    members.forEach(member => {
      const listItem = document.createElement('li');
      listItem.textContent = member;
      membersList.appendChild(listItem);
    });
  }

  function updateLobbyCode(code) {
    lobbyCode.innerHTML = code;
  }
</script>
